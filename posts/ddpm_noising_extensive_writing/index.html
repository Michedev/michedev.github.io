<!doctype html><html lang=en><head><meta charset=utf-8><title>Mathematical Details of Noise Injection in Diffusion Models</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Deep explaination of the mathematical details behind diffusion models noise injection."><meta name=author content="Michele De Vita"><link rel=stylesheet href=https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css><link rel=stylesheet href=https://pro.fontawesome.com/releases/v5.10.0/css/all.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/hover.css/2.1.0/css/hover-min.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Rubik:300,400,500,700,900&display=swap"><link rel=stylesheet href=/plugins/text-animation/text-animation.css><link rel=stylesheet href=/plugins/hugrid/hugrid.css><link rel=stylesheet href=/css/style.min.css media=screen><script async src="https://www.googletagmanager.com/gtag/js?id=G-ABCDEFG123"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ABCDEFG123")</script></head><body><div class=preloader><img src=/images/preloader.gif alt=preloader></div><section class="menu menu-fix" id=menu><nav><div class=menu-container><ul class="desktop-menu list-inline mb-0" id=desktop-menu><li class="menu-item hvr-underline-from-left 1"><a href=/>Home</a></li><li class="menu-item hvr-underline-from-left 2"><a href=/#about>About me</a></li><li class="menu-item hvr-underline-from-left 3"><a href=/#posts>Posts</a></li><li class="menu-item hvr-underline-from-left 4"><a href=/art-gallery>Art gallery</a></li></ul><div class=mobile-menu><div class=mobile-menu-nav><a class=menu-link><span></span>
<span></span>
<span></span></a></div><div class=mobile-menu-logo><a href=/><img class=img-fluid src=/images/logo-dark.svg alt="Mikedev website"></a></div><div class=menu-slider><nav><ul class=mobile-menu-list><li class="mobile-menu-item 1 mx-auto"><a href=/>Home</a></li><li class="mobile-menu-item 1 mx-auto"><a href=/#about>About me</a></li><li class="mobile-menu-item 1 mx-auto"><a href=/#posts>Posts</a></li><li class="mobile-menu-item 1 mx-auto"><a href=/art-gallery>Art gallery</a></li></ul><ul class="mobile-menu-icons list-inline mx-auto"><li><a href=https://github.com/Michedev/><i class="fab fab fa-github fa-2x"></i></a></li><li><a href=https://www.linkedin.com/in/michele-de-vita-582336bb/><i class="fab fab fa-linkedin fa-2x"></i></a></li><li><a href=mailto:mik3dev@gmail.com><i class="fab fas fa-envelope fa-2x"></i></a></li></ul></nav></div></div></div></nav></section><div class="under-menu col-lg-8 col-md-10 col-12 mx-auto post-container"><h1>Mathematical Details of Noise Injection in Diffusion Models</h1><span class=date>Posted on: 08/04/2023</span>
<img src=/images/ddpm_noising.png alt="Mathematical Details of Noise Injection in Diffusion Models"><div class=body><h3 id=diffusion-process>Diffusion process</h3><p>Let $X_0$ the input image, the goal of the diffusion process is to gradually add noise to the image until its pixel values approximate a standard normal distribution. This enables a neural network to be trained to reverse the diffusion process and reconstruct the original image from the noised image. In this post, we will focus on the mathematical details behind the noise injection step of the diffusion process. The single step of injecting noise can be defined as follows:</p><p>$$X_t \sim N( \sqrt{1 - \beta_t} X_{t-1}, \beta_t \mathbf{I}) $$</p><p>where $\beta_t$ is the fixed variance of the Gaussian distribution at time $t$. The variance of the diffusion process is defined to be strictly increasing with time, i.e. $\beta_1 &lt; \beta_2 &mldr; &lt; \beta_T $.</p><h4 id=noising-process>Noising process</h4><p>We can compute the value of $X_t$ by sampling from its distribution. However, to do it in a differentiable way, we can use the reparametrization trick as follows:</p><p>$$ X_t =\sqrt{1 - \beta_t} X_{t-1} + \sqrt{\beta_t} \epsilon_t $$</p><p>where $\epsilon_t \sim N(0, \mathbf{I})$. As in the original paper, we can reparametrize $\beta_t$ as $\alpha_t = 1 - \beta_t $ and therefore rewrite the latter equation as $$ X_t =\sqrt{\alpha_t} X_{t-1} + \sqrt{1 - \alpha_t} \epsilon_t $$</p><p>Now, let&rsquo;s go deeper and write $X_t$ as a function of $X_{t-2}$:
$$
\begin{align*}
X_t & = \sqrt{\alpha_t} X_{t-1} + \sqrt{1 - \alpha_t} \epsilon_t \\
& = \sqrt{\alpha_t} (\sqrt{\alpha_{t-1}} X_{t-2} + \sqrt{1 - \alpha_{t-1}} \epsilon_{t-1}) + \sqrt{1 - \alpha_t} \epsilon_t \\
& = \sqrt{\alpha_t \alpha_{t-1}} X_{t-2} + \underbrace{\sqrt{\alpha_t (1 - \alpha_{t-1})} \epsilon_{t-1}}_{N(\mathbf{0}, \sqrt{\alpha_t (1 - \alpha_{t-1})} \mathbf{I})} + \underbrace{\sqrt{1 - \alpha_t} \epsilon_t}_{N(\mathbf{0}, \sqrt{1 - \alpha_t} \mathbf{I})} \\
& = \sqrt{\alpha_t \alpha_{t-1}} X_{t-2} + \sqrt{\alpha_t (1 - \alpha_{t-1}) + (1 - \alpha_t)} \hat{\epsilon_{t-1}} \\
& = \sqrt{\alpha_t \alpha_{t-1}} X_{t-2} + \sqrt{1 - \alpha_t \alpha_{t-1}} \hat{\epsilon_{t-1}}
\end{align*}
$$
where $\hat{\epsilon_{t-1}} \sim N(\mathbf{0}, \mathbf{I})$.
In the last step of the equation above, we have used the fact that the sum of two independent Gaussian random variables is also a Gaussian random variable with mean equal to the sum of the means and variance equal to the sum of the variances, i.e. $N(\mu_1, \sigma_1^2) + N(\mu_2, \sigma_2^2) = N(\mu_1 + \mu_2, \sigma_1^2 + \sigma_2^2)$. Finally, we can continue this process until we reach $X_0$:
$$
\begin{align*}
X_t & = \sqrt{\alpha_t} X_{t-1} + \sqrt{1 - \alpha_t} \epsilon_t \\
& = \sqrt{\alpha_t \alpha_{t-1} \dots \alpha_1} X_0 + \sqrt{ (1 - \alpha_t \alpha_{t-1} \dots \alpha_1)} \hat{\epsilon_{t-1}}
\end{align*}
$$</p><p>Let $\overline{\alpha_t} = \alpha_t \alpha_{t-1} \dots \alpha_1$ then we can rewrite the latter equation as follows:
$$
X_t = \sqrt{\overline{\alpha_t}} X_0 + \sqrt{1 - \overline{\alpha_t}} \hat{\epsilon_{t-1}}
$$</p></div></div><div class="footer container text-center" id=contact><ul class="footer-icons list-inline"><li><a href=https://github.com/Michedev/ target=_blank rel=noreferrer><i class="fab fa-github footer-icon fa-3x" aria-label></i></a></li><li><a href=https://www.linkedin.com/in/michele-de-vita-582336bb/ target=_blank rel=noreferrer><i class="fab fa-linkedin footer-icon fa-3x" aria-label></i></a></li><li><a href=mailto:mik3dev@gmail.com target=_blank rel=noreferrer><i class="fas fa-envelope footer-icon fa-3x" aria-label></i></a></li></ul><div class=credit>Copyright Burton Guster Â©
<span id=current-year></span></div></div><script src=https://code.jquery.com/jquery-3.5.1.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.js></script>
<script src=/plugins/text-animation/text-animation.js></script>
<script src=/plugins/hugrid/hugrid.min.js></script>
<script src=/js/script.min.js></script>
<script src=/js/hugrid.custom.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css integrity=sha384-GvrOXuhMATgEsSwCs4smul74iXGOixntILdUW9XmUC6+HX0sLNAK3q71HotJqlAn crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js integrity=sha384-cpW21h6RZv/phavutF+AuVYrr+dA8xD9zs6FwLpaCct6O9ctzYFfFr4dgmgccOTx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script></body></html>